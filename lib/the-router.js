(function(){function require(path,parent){var realpath=require.resolve(path,parent),m=require.mods[realpath];if(!m.init){m.factory.call(this,require.local(realpath),m.module,m.module.exports);m.init=true}return m.module.exports}require.mods={};require.local=function(path){var r=function(id){return require(id,path)};r.resolve=function(id){return require.resolve(id,path)};return r};require.register=function(path,mod,aliases){require.mods[path]={factory:mod,aliases:aliases,module:{exports:{}}}};require.aliases=undefined;require.alias=function(path){for(var alias in require.aliases)if(path.indexOf(alias)==0)return require.aliases[alias]+path.match(/\/(.+)/)[0];return null};require.resolve=function(path,parent){var realpath;if(parent){if(!(realpath=require.mods[parent].aliases[path]))realpath=require.alias(path)}else realpath=path;if(!require.mods[realpath])throw new Error("Module not found: "+path);return realpath};window.require=require;require.register("node_modules/the-event/lib/event",function(require,module,exports){var Event,__slice=[].slice;module.exports=Event=function(){function Event(){}Event.prototype.on=function(key,callback){var pool;pool=this.__listeners||(this.__listeners=[]);return(pool[key]||(pool[key]=[])).push(callback)};Event.prototype.off=function(key,callback){var pool,_ref;if((pool=(_ref=this.__listeners)!=null?_ref[key]:void 0)!=null){return pool.splice(pool.indexOf(callback),1)}};Event.prototype.once=function(key,callback){var wrapper,_this=this;return this.on(key,wrapper=function(){_this.off(key,wrapper);return callback.apply(_this,arguments)})};Event.prototype.emit=function(){var args,key,listener,pool,_i,_len,_ref,_ref1,_results;key=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if((pool=(_ref=this.__listeners)!=null?_ref[key]:void 0)!=null){_ref1=pool.slice(0);_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){listener=_ref1[_i];_results.push(listener.apply(this,args))}return _results}};Event.mixin=function(target){var prop,_results;_results=[];for(prop in this.prototype){_results.push(target[prop]=this.prototype[prop])}return _results};return Event}()},{});require.register("src/flow",function(require,module,exports){var Flow,Fluid,find,reject;Fluid=require("./fluid");find=function(arr,filter){var item,_i,_len;for(_i=0,_len=arr.length;_i<_len;_i++){item=arr[_i];if(filter(item)){return item}}};reject=function(arr,filter){var item,_i,_len,_results;_results=[];for(_i=0,_len=arr.length;_i<_len;_i++){item=arr[_i];if(!filter(item)){_results.push(item)}}return _results};module.exports=Flow=function(){Flow.prototype.router=null;Flow.prototype.deads=null;Flow.prototype.atives=null;Flow.prototype.pendings=null;function Flow(router){this.router=router;this.deads=[];this.actives=[];this.pendings=[]}Flow.prototype.run=function(url,route){var fluid,_this=this;fluid=new Fluid(route,url);this.filter_pendings(fluid);this.filter_deads();if(this.router.mode==="render+destroy"){this.run_pendings(url,function(){return _this.destroy_deads(function(){})})}if(this.router.mode==="destroy+render"){return this.destroy_deads(function(){return _this.run_pendings(url,function(){})})}};Flow.prototype._find_dependency=function(parent){var fluid,route;fluid=find(this.actives,function(f){return f.url===parent.dependency});if(fluid!=null){return fluid}route=find(this.router.routes,function(r){return r.matcher.test(parent.route.dependency)});if(route!=null){return new Fluid(route,parent.dependency)}return null};Flow.prototype.filter_pendings=function(parent){var err,fluid,route;this.pendings.unshift(parent);if(parent.dependency==null){return}if((fluid=this._find_dependency(parent))!=null){return this.filter_pendings(fluid)}route=parent.route.pattern;err="Dependency '"+parent.dependency+"' not found for route '"+route+"'";throw new Error(err)};Flow.prototype.filter_deads=function(){var fluid,is_pending,_i,_len,_ref,_results;_ref=this.actives;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){fluid=_ref[_i];is_pending=find(this.pendings,function(f){return f.url===fluid.url});if(!is_pending){_results.push(this.deads.push(fluid))}else{_results.push(void 0)}}return _results};Flow.prototype.run_pendings=function(url,done){var fluid,is_active,_this=this;if(this.pendings.length===0){return done()}fluid=this.pendings.shift();is_active=find(this.actives,function(f){return f.url===fluid.url});if(is_active){return this.run_pendings(url,done)}this.actives.push(fluid);return fluid.run(url,function(){return _this.run_pendings(url,done)})};Flow.prototype.destroy_deads=function(done){var fluid,_this=this;if(this.deads.length===0){return done()}fluid=this.deads.pop();this.actives=reject(this.actives,function(f){return f.url===fluid.url});return fluid.destroy(function(){return _this.destroy_deads(done)})};return Flow}()},{"./fluid":"src/fluid"});require.register("src/fluid",function(require,module,exports){var Fluid;module.exports=Fluid=function(){Fluid.prototype.route=null;Fluid.prototype.dependency=null;function Fluid(route,url){this.route=route;this.url=url;if(this.route.dependency!=null){this.dependency=this.route.computed_dependency(this.url)}}Fluid.prototype.run=function(url,done){return this.req=this.route.run(this.url,done)};Fluid.prototype.destroy=function(done){return this.route.destroy(this.req,done)};return Fluid}()},{});require.register("src/route",function(require,module,exports){var Route;module.exports=Route=function(){var named_param_reg,optional_param_reg,splat_param_reg;Route.prototype.pattern=null;Route.prototype.runner=null;Route.prototype.destroyer=null;Route.prototype.dependency=null;Route.prototype.matcher=null;named_param_reg=/:\w+/g;splat_param_reg=/\*\w+/g;optional_param_reg=/\/(?:\:|\*)(\w+)\?/g;function Route(pattern,runner,destroyer,dependency){this.pattern=pattern;this.runner=runner;this.destroyer=destroyer;this.dependency=dependency;if(this.pattern==="*"){this.matcher=/.*/}else{this.matcher=pattern.replace(optional_param_reg,"(?:/)?:$1?");this.matcher=this.matcher.replace(named_param_reg,"([^/]+)");this.matcher=this.matcher.replace(splat_param_reg,"(.*?)");this.matcher=new RegExp("^"+this.matcher+"$","m")}}Route.prototype.extract_params=function(url){var index,name,names,params,vals,_i,_len;names=this.pattern.match(/(?::|\*)(\w+)/g);if(names==null){return{}}vals=url.match(this.matcher);params={};for(index=_i=0,_len=names.length;_i<_len;index=++_i){name=names[index];params[name.substr(1)]=vals[index+1]}return params};Route.prototype.rewrite_pattern=function(pattern,url){var key,reg,value,_ref;_ref=this.extract_params(url);for(key in _ref){value=_ref[key];reg=new RegExp("[:*]+"+key,"g");pattern=pattern.replace(reg,value)}return pattern};Route.prototype.computed_dependency=function(url){return this.rewrite_pattern(this.dependency,url)};Route.prototype.run=function(url,done){var req;req={url:url,pattern:this.pattern,params:this.extract_params(url)};this.runner(req,done);return req};Route.prototype.destroy=function(req,done){return this.destroyer(req,done)};return Route}()},{});require.register("src/router",function(require,module,exports){var Event,Flow,Route,Router,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Event=require("the-event");Route=require("./route");Flow=require("./flow");Router=function(_super){__extends(Router,_super);Router.prototype.mode=null;Router.prototype.flow=null;Router.prototype.routes=null;Router.prototype.middlware=null;function Router(mode){this.mode=mode;this.routes=[];if(this.mode!=null){this.flow=new Flow(this)}}Router.prototype.use=function(Middleware){return this.middleware=new Middleware};Router.prototype.init=function(){var _this=this;if(this.middleware!=null){this.middleware.on("url:change",function(){return _this.route(_this.middleware.get_location())});return this.route(this.middleware.get_location())}};Router.prototype.get=function(pattern,run,destroy,dependency){var route;route=new Route(pattern,run,destroy,dependency);this.routes.push(route);return route};Router.prototype.route=function(url){var route,_i,_len,_ref;url="/"+url.replace(/^[\/]+|[\/]+$/m,"");_ref=this.routes;for(_i=0,_len=_ref.length;_i<_len;_i++){route=_ref[_i];if(route.matcher.test(url)){return this.run(route,url)}}throw new Error("Route not found for url '"+url+"'")};Router.prototype.run=function(route,url){if(this.mode!=null){this.flow.run(url,route)}else{route.run(url)}this.emit("url:change",url);return route};Router.prototype.redirect=function(url,title,state,silent){if(this.middleware!=null){if(silent){return this.middleware.replaceState(url,title,state)}else{return this.middleware.pushState(url,title,state)}}else{return this.route(url)}};return Router}(Event);if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null){module.exports=Router}else if((typeof define!=="undefined"&&define!==null?define.amd:void 0)!=null){define(function(){return Router})}else{window.TheRouter=Router}},{"the-event":"node_modules/the-event/lib/event","./route":"src/route","./flow":"src/flow"});require("src/router")})();